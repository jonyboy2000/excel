!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.PpTable=t()}(this,function(){"use strict";function isUseless(e){return null==e}function isDef(e){return null!=e}function setText(e,t){e.textContent=t}function setLineCss(e,t,o){e.style[t]=o}function setHtml(e,t){e.innerHTML=t}function insertBefore(e,t){t.parentNode.insertBefore(e,t)}function removeEl(e){e.parentNode.removeChild(e)}function interTwoArr(e,t){return e.filter(function(e){return-1<t.indexOf(e)})}function diffTwoArr(t,o){return t.concat(o).filter(function(e){return t.indexOf(e)<0||o.indexOf(e)<0})}function diffTwoArrs(o,n){return o.concat(n).filter(function(e){var t=e.filter(function(e){return o.indexOf(e)<0||n.indexOf(e)<0});return o.indexOf(t)<0||n.indexOf(t)<0})}function addClass(t,e){if(e&&(e=e.trim()))if(t.classList)-1<e.indexOf(" ")?e.split(/\s+/).forEach(function(e){return t.classList.add(e)}):t.classList.add(e);else{var o=" "+(t.getAttribute("class")||"")+" ";o.indexOf(" "+e+" ")<0&&t.setAttribute("class",(o+e).trim())}}function removeClass(t,e){if(e&&(e=e.trim()))if(t.classList)-1<e.indexOf(" ")?e.split(/\s+/).forEach(function(e){return t.classList.remove(e)}):t.classList.remove(e),t.classList.length||t.removeAttribute("class");else{for(var o=" "+(t.getAttribute("class")||"")+" ",n=" "+e+" ";0<=o.indexOf(n);)o=o.replace(n," ");(o=o.trim())?t.setAttribute("class",o):t.removeAttribute("class")}}var colHeaders={"序号":"n"},rowHeaders=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],rowHthColor=["#fff","#f3f3f3"];function PpTable(e){this._init(e)}function initOptions(e,t){t.rowHeaders;e.$options={el:t.el,hasCol:t.hasRow,data:t.data,showRow:t.showRow||!1,showCol:t.showCol||t.hasCol||10,rowHeaders:t.rowHeaders||null,colHeaders:t.colHeaders||colHeaders,colHeadersColorAlternate:Array.isArray(t.colHeadersColorAlternate)?t.colHeadersColorAlternate:!!t.colHeadersColorAlternate&&rowHthColor,contextMenu:!1!==t.contextMenu,setRowHead:function(e){return this.rowHeaders&&this.rowHeaders[e]?this.rowHeaders[e]:rowHeaders[e]?rowHeaders[e]:rowHeaders[parseInt(e/26)-1]+rowHeaders[e%26]},setColHead:function(e,t){return this.colHeaders[t]?"n"===this.colHeaders[t]?e+1:this.colHeaders[t][e]?this.colHeaders[t][e]:e+1:e+1}}}PpTable.prototype._init=function(e){if(!isUseless(e.el)&&""!==e.el){var t=this;initOptions(t,e),t.rowCount=0,t.colCount=0;var o=document.querySelector(t.$options.el);addClass(o,"ohmygodtable"),createTable(t,o)}};var lightAreaArr=[];function createTable(e,t){var o=document.createElement("table"),n=Object.keys(e.$options.colHeaders)[0];createThead(e,o,n),createTr(e,o,n),o.cellPadding=0,o.cellSpacing=0,t.appendChild(o),e.$options.contextMenu&&setContextMenu(e,o),highlightCell(e,t,o)}var oMenu=null,sss;function setContextMenu(a,l){l.oncontextmenu=function(o){oMenu&&document.body.removeChild(oMenu);var e=[{"在上面插入行":insertRowAbove,"在下面插入行":insertRowBelow},{"在左面插入列":insertColLeft,"在右面插入列":insertColRight},{"删除行":deleteRow,"删除列":deleteCol},{"合并单元格":mergeCells}],t="top:"+o.clientY+"px;left:"+o.clientX+"px;";oMenu=document.createElement("div");var n=null,r=null;e.forEach(function(e){for(var t in n=document.createElement("ul"),e)setText(r=document.createElement("li"),t),r.addEventListener("click",e[t].bind(this,a,l,o),!1),r.addEventListener("contextmenu",e[t].bind(this,a,l,o),!0),n.appendChild(r);oMenu.appendChild(n)}),oMenu.id="ppContextMenu",oMenu.style.cssText+=";"+t,document.body.appendChild(oMenu),o.stopPropagation(),document.oncontextmenu=clearMenu,document.onclick=clearMenu,document.onmousewheel=clearMenu,document.onwheel=clearMenu,o.preventDefault()}}function clearMenu(e){oMenu&&document.body.removeChild(oMenu),oMenu=null}function deleteRow(e,t,o){if(!(e.rowCount<0)){var n=o.target.parentNode.rowIndex,r=t.querySelectorAll("tbody th");t.deleteRow(n);for(var a=0;a<r.length;a++)n<=a&&!isNaN(r[a].textContent)&&setText(r[a],1*r[a].textContent-1);e.rowCount--,o.stopPropagation(),window.event&&window.event.preventDefault&&window.event.preventDefault()}}function insertRowAbove(e,t,o){insertRow(e,t,o.target.parentNode.rowIndex),window.event&&window.event.preventDefault&&window.event.preventDefault()}function insertRowBelow(e,t,o){insertRow(e,t,o.target.parentNode.rowIndex+1),window.event&&window.event.preventDefault&&window.event.preventDefault()}function insertRow(e,t,o){var n=t.insertRow(o),r=document.createElement("th");setText(r,o);for(var a,l=t.querySelectorAll("tbody th"),s=0;s<l.length;s++)o-1<=s&&!isNaN(l[s].textContent)&&setText(l[s],1*l[s].textContent+1);n.appendChild(r);for(s=0;s<e.colCount;s++)a=document.createElement("td"),n.appendChild(a);e.rowCount++}function deleteCol(t,e,o){if(!(t.colCount<0)){var n=e.querySelectorAll("tr"),r=o.target.cellIndex;1===n[0].cells.length?[].forEach.call(n,function(e){e.parentNode.removeChild(e),t.rowCount--}):[].forEach.call(n,function(e){e.removeChild(e.cells[r])}),t.colCount--}}function insertColLeft(e,t,o){insertCol(e,t,o.target.cellIndex)}function insertColRight(e,t,o){insertCol(e,t,o.target.cellIndex+1)}function insertCol(e,t,o){var n,r=t.tHead.querySelector("tr"),a=t.childNodes[1].querySelectorAll("tr"),l=document.createElement("th");setText(l,e.$options.setRowHead(o-1)),r.insertBefore(l,r.cells[o]),[].forEach.call(a,function(e){n=document.createElement("td"),e.insertBefore(n,e.cells[o])}),e.colCount++}function mergeCells(e,t,o){var n,r=0,a=0,l=0,s=lightAreaArr.length,i=lightAreaArr[0].length;lightAreaArr.forEach(function(e,o){e.forEach(function(e,t){""!==e.innerHTML&&(r++,a=o,l=t)})}),n=1===r&&a+l!==0?lightAreaArr[a][l].innerHTML:lightAreaArr[0][0].innerHTML,lightAreaArr.forEach(function(e,o){e.forEach(function(e,t){0===o&&0===t?(e.setAttribute("colspan",i),e.setAttribute("rowspan",s),e.innerHTML=n):removeEl(e)})})}var compute=0;function highlightCell(t,e,M){for(var o,n=document.createElement("textarea"),D=[],r=0;r<5;r++)(o=document.createElement("div")).className="border",e.appendChild(o),D.push(o);e.appendChild(n);var O=["display:block;left:","px;top:","px; width:","px;height:","px;"],B="border:2px solid #fff;";M.addEventListener("dblclick",function(e){moveTextArea(t,M,n,D,e)},!1),M.addEventListener("mousedown",function(N){if(clearMenu(),2!==N.button){lightAreaArr.forEach(function(e){e.forEach(function(e){removeClass(e,"area")})});var k,$=[];moveLight(O,B,t,M,n,D,N),this.addEventListener("mousemove",e,!1),this.addEventListener("mouseup",function(){this.removeEventListener("mousemove",e,!1),lightAreaArr=$})}function e(e){if(e.target!==k){k=e.target;var o,n,t,r,a,l,s,i,c=N.target.offsetLeft,d=N.target.offsetTop,u=N.target.offsetWidth,f=N.target.offsetHeight,p=e.target.offsetLeft,h=e.target.offsetTop,C=e.target.offsetWidth,g=e.target.offsetHeight,m=(M.offsetWidth,M.offsetHeight,N.target.parentNode.rowIndex-1),w=(N.target.getAttribute("colspan"),N.target.getAttribute("rowspan")),v=N.target.cellIndex,x=N.target.parentNode.rowIndex+w+1,T=e.target.getAttribute("rowspan"),b=(e.target.getAttribute("colspan"),T?1*e.target.parentNode.rowIndex+1*T-1:e.target.parentNode.rowIndex),A=T?e.target.parentNode.rowIndex-1+T:e.target.parentNode.rowIndex-1,y=e.target.cellIndex,E=[];c<=p&&d<=h?(o=C+(p-c),n=g+(h-d),D.forEach(function(e,t){switch(t){case 0:i=mLCT(O,c,d,2,n);break;case 1:i=mLCT(O,c,d,o,2);break;case 2:i=mLCT(O,c+o,d,2,n);break;case 3:i=mLCT(O,c,d+n,o,2);break;case 4:i=mLCT(O,c+o-3,d+n-3,5,5,B)}e.style.cssText=i}),r=m,a=b,l=v,s=y):p<=c&&h<=d?(o=C+(c-p),n=g+(d-h),D.forEach(function(e,t){switch(t){case 0:i=mLCT(O,p,h,2,n);break;case 1:i=mLCT(O,p,h,o,2);break;case 2:i=mLCT(O,c+u,h,2,n);break;case 3:i=mLCT(O,p,d+f,o,2);break;case 4:i=mLCT(O,c+u-3,d+f-3,5,5,B)}e.style.cssText=i}),r=A,a=x,l=y,s=v):c<=p&&h<=d?(o=u+(p-c),n=f+(d-h),D.forEach(function(e,t){switch(t){case 0:i=mLCT(O,c,h,2,n);break;case 1:i=mLCT(O,c,h,o,2);break;case 2:i=mLCT(O,p+C,h,2,n);break;case 3:i=mLCT(O,c,d+f,o,2);break;case 4:i=mLCT(O,p+C-3,d+f-3,5,5,B)}e.style.cssText=i}),r=A,a=x,l=v,s=y):p<=c&&d<=h&&(o=u+(c-p),n=g+(h-d),D.forEach(function(e,t){switch(t){case 0:i=mLCT(O,p,d,2,n);break;case 1:i=mLCT(O,p,d,o,2);break;case 2:i=mLCT(O,c+u,d,2,n);break;case 3:i=mLCT(O,p,h+g,o,2);break;case 4:i=mLCT(O,c+u-3,h+g-3,5,5,B)}e.style.cssText=i}),r=m,a=b,l=y,s=v);for(var L=0,H=0,I=s;r<a;r++){t=M.children[1].querySelectorAll("tr")[r],E.push([]);for(var R=l;R<=I;R++)H=t.cells[R].getAttribute("rowspan"),console.log(H),t.cells[R].getAttribute("colspan")?I=s-t.cells[R].getAttribute("colspan")+1:0<H?(console.log(H),I=s-t.cells[R].getAttribute("colspan"),H--):I=s,E[L].push(t.cells[R]);L++}diffTwoArrs(E,$).forEach(function(e){e.forEach(function(e){removeClass(e,"area")})}),E.forEach(function(e){e.forEach(function(e){e!==N.target&&addClass(e,"area")})}),$=E}}},!1),n.oninput=function(e){this.style.width=this.scrollWidth+"px",this.style.height=this.scrollHeight+"px"}}var cmpChain={},ggg,dasdas="=";function infinCmp(t,o,n,r,a){if("="===r.value||0!==compute){compute=1,a.target.style.backgroundColor="skyblue",/[+|-|*|/|\(|\)|（|）]$/.test(r.value)?(dasdas=r.value,t.$options.setRowHead[a.target.cellIndex]):ggg&&(cmpChain["R"+ggg.parentNode.rowIndex+"C"+ggg.cellIndex].pop().style.backgroundColor="#fff"),"="===r.value?setTimeout(function(){cmpChain["R"+(ggg=sss).parentNode.rowIndex+"C"+ggg.cellIndex]=[a.target]},0):cmpChain["R"+ggg.parentNode.rowIndex+"C"+ggg.cellIndex].push(a.target),r.value=dasdas+t.$options.setRowHead(a.target.cellIndex-1)+t.$options.setColHead(a.target.parentNode.rowIndex-1,"大师傅大");var l=r.value;document.onkeypress=function(e){13===e.keyCode&&(cmpArr["R"+ggg.parentNode.rowIndex+"C"+ggg.cellIndex]=l,cmpChain["R"+ggg.parentNode.rowIndex+"C"+ggg.cellIndex].forEach(function(e){l=l.split(t.$options.setRowHead(e.cellIndex-1)+t.$options.setColHead(e.parentNode.rowIndex-1,"大师傅大")).join(e.textContent),e.style.backgroundColor="#fff"}),inlineCmp(r,a,l),compute=0,dasdas="=",ggg=null,n.forEach(function(e){e.style.display="none"}),r.style.display="none")},setTimeout(function(){r.focus()},0)}else{r.style.display="none";var s=!0;document.onkeypress=function(e){s&&(13===e.keyCode||moveTextArea(t,o,r,n,a,"write"),s=!s)}}}function moveLight(o,n,e,t,r,a,l){var s,i=l.target.offsetLeft,c=l.target.offsetTop,d=l.target.offsetWidth,u=l.target.offsetHeight,f=t.offsetWidth,p=t.offsetHeight;if("TD"===l.target.nodeName)a.forEach(function(e,t){switch(t){case 0:s=mLCT(o,i,c,2,u);break;case 1:s=mLCT(o,i,c,d,2);break;case 2:s=mLCT(o,i+d,c,2,u);break;case 3:s=mLCT(o,i,c+u,d,2);break;case 4:s=mLCT(o,i+d-3,c+u-3,5,5,n)}e.style.cssText=s});else if("TH"===l.target.nodeName&&"TBODY"===l.target.parentNode.parentNode.nodeName)a.forEach(function(e,t){switch(t){case 0:s=mLCT(o,i,c,2,u);break;case 1:s=mLCT(o,i,c,f,2);break;case 2:s=mLCT(o,i+f,c,2,u);break;case 3:s=mLCT(o,i,c+u,f,2);break;case 4:s=mLCT(o,i+f-3,c+u-3,5,5,n)}e.style.cssText=s});else{if("TH"!==l.target.nodeName||"THEAD"!==l.target.parentNode.parentNode.nodeName)return;a.forEach(function(e,t){switch(t){case 0:s=mLCT(o,i,c,2,p);break;case 1:s=mLCT(o,i,c,d,2);break;case 2:s=mLCT(o,i+d,c,2,p);break;case 3:s=mLCT(o,i,c+p,d,2);break;case 4:s=mLCT(o,i+d-3,c+p-3,5,5,n)}e.style.cssText=s})}infinCmp(e,t,a,r,l)}function mLCT(e,t,o,n,r,a){a=a||"";return e[0]+t+e[1]+o+e[2]+n+e[3]+r+e[4]+a}var cmpArr={};function inlineCmp(textarea,e,value){var val=value||textarea.value;if(val=val.split(/[（|(]/g).join("("),val=val.split(/[）|)]/g).join(")"),/^=.+/.test(val))if(/[(|)|+|-|*|/|0-9|%|‰]$/g.test(val))if(/[0-9|\)]+[%|‰]$/g.test(val)){var newVal=val,reso=/([0-9]+)(%)/g.exec(val),reso1=/\(([^\(]+)\)(%)/g.exec(val),resoo=/\(([^\(]+)\)(‰)/g.exec(val),resoo1=/([0-9]+)(‰)/g.exec(val);reso&&(newVal=newVal.split(reso[0]).join(.01*reso[1])),resoo1&&(newVal=newVal.split(resoo1[0]).join(.001*resoo1[1]));try{reso1&&(newVal=newVal.split(reso1[0]).join(.01*eval(reso1[1]))),resoo&&(newVal=newVal.split(resoo[0]).join(.001*eval(resoo[1]))),textarea.value=eval(/^=(.+)/.exec(newVal)[1]),cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]=cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]||val}catch(e){textarea.value="#VALUE!",alert("此表达式过于复杂或有错误,无法计算")}}else try{textarea.value=eval(/^=(.+)/.exec(val)[1]),cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]=cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]||val}catch(e){textarea.value="#VALUE!",alert("此表达式过于复杂或有错误,无法计算")}else cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]=cmpArr["R"+e.target.parentNode.rowIndex+"C"+e.target.cellIndex]||val,textarea.value="#NAME?"}function moveTextArea(o,e,n,t,r,a){if(document.onkeypress=function(e){if(13===e.keyCode){var t=n.value;cmpChain["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex]?(cmpChain["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex].forEach(function(e){t=t.split(o.$options.setRowHead(e.cellIndex-1)+o.$options.setColHead(e.parentNode.rowIndex-1,"大师傅大")).join(e.textContent)}),inlineCmp(n,r,t)):inlineCmp(n,r)}},"TD"===r.target.nodeName&&0===r.target.children.length){t.forEach(function(e){e.style.display="none"}),n.style.display="block";var l=r.target;n.value=cmpArr["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex]?cmpArr["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex]:"write"===a?"":r.target.textContent?r.target.textContent:"",n.style.left=l.offsetLeft+"px",n.style.top=l.offsetTop+"px",n.style.width=l.scrollWidth+"px",n.style.height=l.scrollHeight+"px",n.focus(),n.onblur=function(){var t=this.value;cmpChain["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex]&&cmpChain["R"+r.target.parentNode.rowIndex+"C"+r.target.cellIndex].forEach(function(e){t=t.split(o.$options.setRowHead(e.cellIndex-1)+o.$options.setColHead(e.parentNode.rowIndex-1,"大师傅大")).join(e.textContent)}),0===compute&&inlineCmp(n,r,t),setText(r.target,this.value),sss=r.target}}}function cmp(e,t){}function createThead(e,t,o){var n=document.createElement("thead"),r=document.createElement("tr");(l=document.createElement("th")).textContent=o,r.appendChild(l),n.appendChild(r);for(var a=0;a<e.$options.showCol;a++){var l;(l=document.createElement("th")).textContent=e.$options.setRowHead(e.colCount),r.appendChild(l),n.appendChild(r),e.colCount++}t.appendChild(n)}var isEven=0;function createTr(a,e,l){var s=document.createElement("tbody");if(a.$options.data.forEach(function(o,e){if(!a.$options.showRow||a.rowCount<a.$options.showRow){var n=document.createElement("tr"),r=createAlternateColor(a.$options);createTh(a,l,n,r),(!a.$options.showRow||a.rowCount<a.$options.showRow+1)&&o.forEach(function(e,t){createTd(a,s,n,e,t,l,r,a.$options.showCol,o.length)})}}),a.rowCount<a.$options.showRow+1)for(var t=a.$options.showRow-a.rowCount,o=0;o<t;o++){var n=document.createElement("tr");createTh(a,l,n,createAlternateColor(options));for(var r=0;r<a.$options.showCol;r++){var i=document.createElement("td");n.appendChild(i)}s.appendChild(n)}e.appendChild(s)}function createTh(e,t,o,n){var r=document.createElement("th");r.style.height="30",r.style.backgroundColor=n,r.textContent=e.$options.setColHead(e.rowCount,t),o.appendChild(r),e.rowCount++}function createAlternateColor(e){var t;return e.colHeadersColorAlternate?(t=e.colHeadersColorAlternate[isEven],isEven=(isEven+1)%e.colHeadersColorAlternate.length):t="#f3f3f3",t}function createTd(o,n,r,a,e,l,s,i,t){if(!1!==Array.isArray(a)){if(0===e);else if(!o.$options.showRow||o.rowCount<o.$options.showRow+1){r=document.createElement("tr");var c=document.createElement("th");c.style.height="30px",c.style.backgroundColor=s,c.textContent=o.$options.setColHead(o.rowCount,l),r.appendChild(c),o.rowCount++}(!o.$options.showRow||o.rowCount<o.$options.showRow+1)&&a.forEach(function(e,t){createTd(o,n,r,e,t,l,s,i,a.length)})}else if(i<t)e<i&&appendDToRToB("td",r,n,a);else if(appendDToRToB("td",r,n,a),e===t-1)for(var d=0;d<i-e-1;d++)appendDToRToB("td",r,n)}function appendDToRToB(e,t,o,n){var r=document.createElement(e);n&&setText(r,n),t.appendChild(r),o.appendChild(t)}function changeCell(o,e,t){for(var n in o){var r=e.querySelectorAll(t[0]+n.split(t[1])[1]+t[2]);o[n].data&&[].forEach.call(r,function(e,t){isDef(o[n].data[t])&&setText(e,o[n].data[t])}),o[n].style&&[].forEach.call(r,function(e,t){setCellCss(e,o[n].style)}),o[n].html&&[].forEach.call(r,function(e,t){setHtml(e,o[n].html)})}}function setCellCss(e,t){for(var o in t)setLineCss(e,o,t[o])}return PpTable.prototype.$updateData=function(){var r=document.querySelector(this.$options.el).getElementsByTagName("tbody")[0];return{rows:function(e){changeCell(e,r,["tr:nth-of-type(","R",") td"])},cols:function(e){changeCell(e,r,["tr td:nth-of-type(","C",")"])},cells:function(e){for(var t in e){var o=/^R(\d)_C(\d)$/.exec(t),n=r.querySelector("tr:nth-child("+o[1]+") td:nth-child("+o[2]+")");e[t].data&&setText(n,e[t].data),e[t].style&&setCellCss(n,e[t].style),e[t].html&&setHtml(n,e[t].html)}}}},PpTable});